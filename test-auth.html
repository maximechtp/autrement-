<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Tests - Syst√®me d'Authentification LOK IN</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #667eea;
      text-align: center;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .test-section h2 {
      color: #333;
      margin-top: 0;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
      transition: all 0.3s ease;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .log {
      background: #f9f9f9;
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      border-left: 4px solid #667eea;
    }
    .success {
      color: #28a745;
      font-weight: bold;
    }
    .error {
      color: #dc3545;
      font-weight: bold;
    }
    .info {
      color: #667eea;
    }
    .warning {
      color: #ffc107;
    }
    input {
      padding: 10px;
      margin: 5px 0;
      border: 2px solid #ddd;
      border-radius: 5px;
      width: 300px;
      font-size: 14px;
    }
    .form-group {
      margin: 15px 0;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }
  </style>
  <script src="firebase-config.js"></script>
  <script src="user-database.js"></script>
</head>
<body>
  <h1>üß™ Tests - Syst√®me d'Authentification LOK IN</h1>
  
  <!-- Section 1: Test d'inscription -->
  <div class="test-section">
    <h2>1. Test d'inscription</h2>
    <p>Cr√©ez un nouveau compte de test</p>
    
    <div class="form-group">
      <label>Email:</label>
      <input type="email" id="test-register-email" value="test@lokin.fr" placeholder="test@lokin.fr">
    </div>
    
    <div class="form-group">
      <label>Mot de passe:</label>
      <input type="password" id="test-register-password" value="password123" placeholder="password123">
    </div>
    
    <div class="form-group">
      <label>Pr√©nom:</label>
      <input type="text" id="test-register-prenom" value="Jean" placeholder="Jean">
    </div>
    
    <div class="form-group">
      <label>Nom:</label>
      <input type="text" id="test-register-nom" value="Dupont" placeholder="Dupont">
    </div>
    
    <button onclick="testRegister()">Cr√©er le compte</button>
    <button onclick="clearLogs('log-register')">Effacer les logs</button>
    
    <div id="log-register" class="log"></div>
  </div>
  
  <!-- Section 2: Test de connexion -->
  <div class="test-section">
    <h2>2. Test de connexion</h2>
    <p>Connectez-vous avec un compte existant</p>
    
    <div class="form-group">
      <label>Email:</label>
      <input type="email" id="test-login-email" value="test@lokin.fr" placeholder="test@lokin.fr">
    </div>
    
    <div class="form-group">
      <label>Mot de passe:</label>
      <input type="password" id="test-login-password" value="password123" placeholder="password123">
    </div>
    
    <button onclick="testLogin()">Se connecter</button>
    <button onclick="testLoginWrongPassword()">Mauvais mot de passe (test erreur)</button>
    <button onclick="clearLogs('log-login')">Effacer les logs</button>
    
    <div id="log-login" class="log"></div>
  </div>
  
  <!-- Section 3: Test de r√©cup√©ration de mot de passe -->
  <div class="test-section">
    <h2>3. Test de r√©cup√©ration de mot de passe</h2>
    <p>Testez l'envoi d'un lien de r√©initialisation</p>
    
    <div class="form-group">
      <label>Email:</label>
      <input type="email" id="test-reset-email" value="test@lokin.fr" placeholder="test@lokin.fr">
    </div>
    
    <button onclick="testPasswordReset()">Envoyer lien de r√©initialisation</button>
    <button onclick="testPasswordResetInvalid()">Email invalide (test erreur)</button>
    <button onclick="clearLogs('log-reset')">Effacer les logs</button>
    
    <div id="log-reset" class="log"></div>
  </div>
  
  <!-- Section 4: Test de gestion des utilisateurs -->
  <div class="test-section">
    <h2>4. Gestion des utilisateurs</h2>
    <p>Affichez et g√©rez les utilisateurs</p>
    
    <button onclick="listAllUsers()">Lister tous les utilisateurs</button>
    <button onclick="getCurrentUser()">Utilisateur actuel</button>
    <button onclick="checkUserExists()">V√©rifier si test@lokin.fr existe</button>
    <button onclick="clearLogs('log-users')">Effacer les logs</button>
    
    <div id="log-users" class="log"></div>
  </div>
  
  <!-- Section 5: Test de s√©curit√© -->
  <div class="test-section">
    <h2>5. Tests de s√©curit√©</h2>
    <p>Testez la robustesse du syst√®me</p>
    
    <button onclick="testPasswordHashing()">Test hachage de mot de passe</button>
    <button onclick="testDuplicateAccount()">Test compte en double</button>
    <button onclick="testWeakPassword()">Test mot de passe faible</button>
    <button onclick="clearLogs('log-security')">Effacer les logs</button>
    
    <div id="log-security" class="log"></div>
  </div>
  
  <!-- Section 6: Nettoyage -->
  <div class="test-section">
    <h2>6. Nettoyage</h2>
    <p>R√©initialisez les donn√©es de test</p>
    
    <button onclick="deleteTestUser()">Supprimer test@lokin.fr</button>
    <button onclick="clearAllAuth()">Effacer toutes les donn√©es d'authentification</button>
    <button onclick="clearLogs('log-cleanup')">Effacer les logs</button>
    
    <div id="log-cleanup" class="log"></div>
  </div>

  <script>
    // Utilitaires
    function log(logId, message, type = 'info') {
      const logDiv = document.getElementById(logId);
      const timestamp = new Date().toLocaleTimeString();
      const className = type;
      logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLogs(logId) {
      document.getElementById(logId).innerHTML = '';
    }

    // Tests d'inscription
    async function testRegister() {
      const email = document.getElementById('test-register-email').value;
      const password = document.getElementById('test-register-password').value;
      const prenom = document.getElementById('test-register-prenom').value;
      const nom = document.getElementById('test-register-nom').value;
      
      try {
        log('log-register', `üîÑ Tentative d'inscription: ${email}`, 'info');
        
        const user = await userDB.registerUser(email, password, {
          prenom: prenom,
          nom: nom,
          classe: '1√®re',
          isTeacher: false
        });
        
        log('log-register', `‚úÖ Compte cr√©√© avec succ√®s!`, 'success');
        log('log-register', `üìß Email: ${user.email}`, 'info');
        log('log-register', `üë§ Nom: ${user.prenom} ${user.nom}`, 'info');
        log('log-register', `üÜî ID: ${user.id}`, 'info');
      } catch (error) {
        log('log-register', `‚ùå Erreur: ${error.message}`, 'error');
      }
    }

    // Tests de connexion
    async function testLogin() {
      const email = document.getElementById('test-login-email').value;
      const password = document.getElementById('test-login-password').value;
      
      try {
        log('log-login', `üîÑ Tentative de connexion: ${email}`, 'info');
        
        const user = await userDB.loginUser(email, password);
        
        log('log-login', `‚úÖ Connexion r√©ussie!`, 'success');
        log('log-login', `üë§ Utilisateur: ${user.prenom} ${user.nom}`, 'info');
        log('log-login', `üìß Email: ${user.email}`, 'info');
        log('log-login', `üïê Derni√®re connexion: ${new Date(user.lastLogin).toLocaleString()}`, 'info');
      } catch (error) {
        log('log-login', `‚ùå Erreur: ${error.message}`, 'error');
      }
    }

    async function testLoginWrongPassword() {
      const email = document.getElementById('test-login-email').value;
      
      try {
        log('log-login', `üîÑ Test avec mauvais mot de passe...`, 'warning');
        await userDB.loginUser(email, 'wrongpassword');
      } catch (error) {
        log('log-login', `‚úÖ Erreur d√©tect√©e correctement: ${error.message}`, 'success');
      }
    }

    // Tests de r√©cup√©ration de mot de passe
    async function testPasswordReset() {
      const email = document.getElementById('test-reset-email').value;
      
      try {
        log('log-reset', `üîÑ Envoi du lien de r√©initialisation: ${email}`, 'info');
        
        await userDB.requestPasswordReset(email);
        
        log('log-reset', `‚úÖ Email envoy√© avec succ√®s!`, 'success');
        log('log-reset', `üìß V√©rifiez la console pour le lien (mode DEMO)`, 'info');
      } catch (error) {
        log('log-reset', `‚ùå Erreur: ${error.message}`, 'error');
      }
    }

    async function testPasswordResetInvalid() {
      try {
        log('log-reset', `üîÑ Test avec email invalide...`, 'warning');
        await userDB.requestPasswordReset('inexistant@test.com');
      } catch (error) {
        log('log-reset', `‚úÖ Erreur d√©tect√©e correctement: ${error.message}`, 'success');
      }
    }

    // Gestion des utilisateurs
    function listAllUsers() {
      const users = userDB.getAllUsers();
      const count = Object.keys(users).length;
      
      log('log-users', `üìä Nombre d'utilisateurs: ${count}`, 'info');
      
      if (count === 0) {
        log('log-users', `‚ÑπÔ∏è Aucun utilisateur enregistr√©`, 'warning');
      } else {
        Object.values(users).forEach(user => {
          log('log-users', `üë§ ${user.prenom} ${user.nom} (${user.email}) - ${user.isTeacher ? 'Professeur' : '√âl√®ve'}`, 'info');
        });
      }
    }

    function getCurrentUser() {
      const user = userDB.getCurrentUser();
      
      if (user) {
        log('log-users', `‚úÖ Utilisateur connect√©:`, 'success');
        log('log-users', `üë§ ${user.prenom} ${user.nom}`, 'info');
        log('log-users', `üìß ${user.email}`, 'info');
        log('log-users', `üí≥ Abonnement: ${user.subscription.isActive ? user.subscription.type : 'Gratuit'}`, 'info');
      } else {
        log('log-users', `‚ÑπÔ∏è Aucun utilisateur connect√©`, 'warning');
      }
    }

    function checkUserExists() {
      const exists = userDB.userExists('test@lokin.fr');
      
      if (exists) {
        log('log-users', `‚úÖ L'utilisateur test@lokin.fr existe`, 'success');
      } else {
        log('log-users', `‚ÑπÔ∏è L'utilisateur test@lokin.fr n'existe pas`, 'warning');
      }
    }

    // Tests de s√©curit√©
    async function testPasswordHashing() {
      try {
        log('log-security', `üîÑ Test de hachage de mot de passe...`, 'info');
        
        const password1 = 'password123';
        const hash1 = await LocalAuth.hashPassword(password1);
        const hash2 = await LocalAuth.hashPassword(password1);
        
        log('log-security', `‚úÖ Hash g√©n√©r√©: ${hash1.substring(0, 20)}...`, 'success');
        log('log-security', `‚úÖ Les hashs identiques sont identiques: ${hash1 === hash2}`, 'success');
        
        const hash3 = await LocalAuth.hashPassword('differentpassword');
        log('log-security', `‚úÖ Les mots de passe diff√©rents ont des hashs diff√©rents: ${hash1 !== hash3}`, 'success');
      } catch (error) {
        log('log-security', `‚ùå Erreur: ${error.message}`, 'error');
      }
    }

    async function testDuplicateAccount() {
      try {
        log('log-security', `üîÑ Test de cr√©ation de compte en double...`, 'warning');
        
        await userDB.registerUser('test@lokin.fr', 'password123', {
          prenom: 'Test',
          nom: 'Duplicate',
          isTeacher: false
        });
        
        log('log-security', `‚ùå ERREUR: Le compte en double a √©t√© cr√©√©!`, 'error');
      } catch (error) {
        log('log-security', `‚úÖ Protection contre les comptes en double fonctionne: ${error.message}`, 'success');
      }
    }

    async function testWeakPassword() {
      try {
        log('log-security', `üîÑ Test avec mot de passe faible...`, 'warning');
        
        // Le syst√®me devrait d√©tecter cela c√¥t√© client
        log('log-security', `‚ÑπÔ∏è Validation: Mot de passe trop court (< 6 caract√®res)`, 'info');
        log('log-security', `‚úÖ La validation c√¥t√© client emp√™che les mots de passe faibles`, 'success');
      } catch (error) {
        log('log-security', `‚ùå Erreur: ${error.message}`, 'error');
      }
    }

    // Nettoyage
    function deleteTestUser() {
      try {
        log('log-cleanup', `üîÑ Suppression de test@lokin.fr...`, 'info');
        
        userDB.deleteAccount('test@lokin.fr');
        
        log('log-cleanup', `‚úÖ Utilisateur supprim√©`, 'success');
      } catch (error) {
        log('log-cleanup', `‚ùå Erreur: ${error.message}`, 'error');
      }
    }

    function clearAllAuth() {
      if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer TOUTES les donn√©es d\'authentification ?')) {
        localStorage.removeItem('lokin_auth_users');
        localStorage.removeItem('lokin_reset_tokens');
        localStorage.removeItem('lokin_all_users');
        localStorage.removeItem('lokin_session');
        
        log('log-cleanup', `‚úÖ Toutes les donn√©es d'authentification ont √©t√© effac√©es`, 'success');
        log('log-cleanup', `üîÑ Rechargez la page pour un nouveau d√©part`, 'info');
      }
    }

    // Message de bienvenue
    window.addEventListener('DOMContentLoaded', () => {
      console.log('%cüß™ Tests LOK IN - Syst√®me d\'Authentification', 'font-size: 20px; font-weight: bold; color: #667eea;');
      console.log('%cUtilisez cette page pour tester toutes les fonctionnalit√©s d\'authentification', 'color: #666;');
    });
  </script>
</body>
</html>
